<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜æƒ å‡­è¯ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- çœŸæ­£çš„äºŒç»´ç ç”Ÿæˆå™¨ -->
    <script src="/static/js/qrcode-generator.js"></script>
    <script>
        console.log('çœŸæ­£çš„äºŒç»´ç ç”Ÿæˆå™¨å·²åŠ è½½');
    </script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; flex: 1; }
        .stat-number { font-size: 24px; font-weight: bold; color: #409EFF; }
        .stat-label { color: #666; margin-top: 5px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .table-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .empty-state { text-align: center; padding: 50px; color: #666; }
        .empty-state h3 { color: #999; margin-bottom: 10px; }
        .brand-info { margin-top: 15px; }
        .brand-name { 
            background: rgba(255, 255, 255, 0.2); 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 16px; 
            font-weight: bold; 
            color: #fff; 
            display: inline-block;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div id="app">
        <div class="header">
            <h1>{{ title }}</h1>
            <p>ç”µå­ç¥¨æ®ç”Ÿæˆã€éªŒè¯ã€æ ¸é”€ä¸€ä½“åŒ–ç®¡ç†</p>
            <div class="brand-info">
                <span class="brand-name">ğŸ¢ é‡‘æ½®ç”·è£…ä¾›åº”é“¾</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ totalVouchers }}</div>
                <div class="stat-label">æ€»å‡­è¯æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ unusedVouchers }}</div>
                <div class="stat-label">æœªä½¿ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ usedVouchers }}</div>
                <div class="stat-label">å·²ä½¿ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{{ totalAmount }}</div>
                <div class="stat-label">æ€»é‡‘é¢</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{{ usedAmount }}</div>
                <div class="stat-label">å·²ä½¿ç”¨é‡‘é¢</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{{ unusedAmount }}</div>
                <div class="stat-label">æœªä½¿ç”¨é‡‘é¢</div>
            </div>
        </div>

        <div class="toolbar">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <el-button type="primary" @click="showAdd = true">â• æ–°å¢å‡­è¯</el-button>
                <el-button @click="refreshData">ğŸ”„ åˆ·æ–°æ•°æ®</el-button>
                <el-button type="success" @click="exportExcel">ğŸ“¤ å¯¼å‡ºExcel</el-button>
                <el-button type="warning" @click="$refs.fileInput.click()">ğŸ“¥ å¯¼å…¥Excel</el-button>
                <input 
                    ref="fileInput" 
                    type="file" 
                    accept=".xlsx,.xls" 
                    style="display: none;" 
                    @change="importExcel">
            </div>
            <div>
                <el-input v-model="searchText" placeholder="æœç´¢..." style="width: 250px;" clearable></el-input>
            </div>
        </div>

        <!-- ç©ºæ•°æ®çŠ¶æ€ -->
        <div v-if="!loading && filteredVouchers.length === 0" class="empty-state">
            <h3>ğŸ“ æš‚æ— å‡­è¯æ•°æ®</h3>
            <p v-if="searchText">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "{{ searchText }}" çš„å‡­è¯è®°å½•</p>
            <p v-else>ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•å‡­è¯è®°å½•</p>
            <el-button type="primary" @click="showAdd = true" v-if="!searchText">ç«‹å³æ·»åŠ å‡­è¯</el-button>
            <el-button @click="searchText = ''" v-if="searchText">æ¸…é™¤æœç´¢</el-button>
        </div>

        <!-- ç©ºæ•°æ®çŠ¶æ€ -->
        <!-- <div v-if="!loading && filteredVouchers.length === 0" style="text-align: center; padding: 50px; color: #666;">
            <h3 style="color: #999; margin-bottom: 10px;">ğŸ“ æš‚æ— å‡­è¯æ•°æ®</h3>
            <p v-if="searchText">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "{{ searchText }}" çš„å‡­è¯è®°å½•</p>
            <p v-else>ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•å‡­è¯è®°å½•</p>
            <el-button type="primary" @click="showAdd = true" v-if="!searchText">ç«‹å³æ·»åŠ å‡­è¯</el-button>
            <el-button @click="searchText = ''" v-if="searchText">æ¸…é™¤æœç´¢</el-button>
        </div> -->

        <!-- æ•°æ®è¡¨æ ¼ -->
        <el-table 
            v-if="!loading && filteredVouchers.length > 0"
            :data="paginatedVouchers" 
            style="width: 100%;" 
            v-loading="loading"
            height="600">
            <el-table-column prop="voucher_id" label="å‡­è¯å·" width="150" show-overflow-tooltip></el-table-column>
            <el-table-column prop="customer" label="å®¢æˆ·" width="120" show-overflow-tooltip></el-table-column>
            <el-table-column prop="sku" label="æ¬¾å·" width="100" show-overflow-tooltip></el-table-column>
            <el-table-column prop="qty" label="ä»¶æ•°" width="80" align="center"></el-table-column>
            <el-table-column prop="price" label="é‡‘é¢" width="100" align="right">
                <template #default="scope">Â¥{{ scope.row.price }}</template>
            </el-table-column>
            <el-table-column prop="status" label="çŠ¶æ€" width="100" align="center">
                <template #default="scope">
                    <el-tag :type="scope.row.status === 'å·²ä½¿ç”¨' ? 'danger' : 'success'">
                        {{ scope.row.status }}
                    </el-tag>
                </template>
            </el-table-column>
            <el-table-column prop="used_date" label="ä½¿ç”¨æ—¶é—´" width="150" align="center">
                <template #default="scope">
                    <span v-if="scope.row.status === 'å·²ä½¿ç”¨' && scope.row.used_date">
                        {{ scope.row.used_date }}
                    </span>
                    <span v-else style="color: #ccc;">-</span>
                </template>
            </el-table-column>
            <el-table-column label="æ“ä½œ" width="320" align="center">
          <template #default="scope">
                    <el-button size="small" @click="editVoucher(scope.row)">âœï¸ ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" @click="confirmDelete(scope.row.voucher_id)">ğŸ—‘ï¸ åˆ é™¤</el-button>
                    <el-button 
                        size="small" 
                        :type="scope.row.status === 'æœªä½¿ç”¨' ? 'warning' : 'info'"
                        :disabled="scope.row.status === 'å·²ä½¿ç”¨'"
                        @click="toggleStatus(scope.row)">
                        {{ scope.row.status === 'æœªä½¿ç”¨' ? 'âœ… æ ¸é”€' : 'â™»ï¸ å·²æ ¸é”€' }}
                    </el-button>
                    <el-button size="small" type="success" @click="showQRCode(scope.row)">ğŸ“± äºŒç»´ç </el-button>
          </template>
        </el-table-column>
      </el-table>

        <!-- åˆ†é¡µç»„ä»¶ -->
        <div class="table-footer" v-if="!loading && filteredVouchers.length > 0">
            <div>
                å…± {{ filteredVouchers.length }} æ¡è®°å½•ï¼Œå½“å‰ç¬¬ {{ currentPage }} / {{ totalPages }} é¡µ
            </div>
            <el-pagination
                v-model:current-page="currentPage"
                v-model:page-size="pageSize"
                :page-sizes="[50, 100, 200, 500]"
                :total="filteredVouchers.length"
                layout="total, sizes, prev, pager, next, jumper"
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange">
            </el-pagination>
        </div>

        <!-- æ–°å¢å‡­è¯å¼¹çª— -->
        <el-dialog v-model="showAdd" title="æ–°å¢å‡­è¯" width="500px">
            <el-form :model="newVoucher" label-width="80px">
                <el-form-item label="å®¢æˆ·å§“å">
                    <el-input v-model="newVoucher.customer" placeholder="è¯·è¾“å…¥å®¢æˆ·å§“å"></el-input>
                </el-form-item>
                <el-form-item label="å•†å“æ¬¾å·">
                    <el-input v-model="newVoucher.sku" placeholder="è¯·è¾“å…¥å•†å“æ¬¾å·"></el-input>
                </el-form-item>
                <el-form-item label="ä»¶æ•°">
                    <el-input-number v-model="newVoucher.qty" :min="1" style="width: 100%;"></el-input-number>
                </el-form-item>
                <el-form-item label="é‡‘é¢">
                    <el-input-number v-model="newVoucher.price" :min="0" :precision="2" style="width: 100%;"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showAdd = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="addVoucher" :loading="saving">ä¿å­˜</el-button>
            </template>
        </el-dialog>

        <!-- ç¼–è¾‘å‡­è¯å¼¹çª— -->
        <el-dialog v-model="showEdit" title="ç¼–è¾‘å‡­è¯" width="500px">
            <el-form :model="editingVoucher" label-width="80px">
                <el-form-item label="å‡­è¯å·">
                    <el-input v-model="editingVoucher.voucher_id" disabled></el-input>
                </el-form-item>
                <el-form-item label="å®¢æˆ·å§“å">
                    <el-input v-model="editingVoucher.customer" placeholder="è¯·è¾“å…¥å®¢æˆ·å§“å"></el-input>
                </el-form-item>
                <el-form-item label="å•†å“æ¬¾å·">
                    <el-input v-model="editingVoucher.sku" placeholder="è¯·è¾“å…¥å•†å“æ¬¾å·"></el-input>
                </el-form-item>
                <el-form-item label="ä»¶æ•°">
                    <el-input-number v-model="editingVoucher.qty" :min="1" style="width: 100%;"></el-input-number>
                </el-form-item>
                <el-form-item label="é‡‘é¢">
                    <el-input-number v-model="editingVoucher.price" :min="0" :precision="2" style="width: 100%;"></el-input-number>
                </el-form-item>
                <el-form-item label="çŠ¶æ€">
                    <el-radio-group v-model="editingVoucher.status">
                        <el-radio label="æœªä½¿ç”¨">æœªä½¿ç”¨</el-radio>
                        <el-radio label="å·²ä½¿ç”¨">å·²ä½¿ç”¨</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showEdit = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="updateVoucher" :loading="saving">ä¿å­˜</el-button>
            </template>
      </el-dialog>

        <!-- å‡­è¯äºŒç»´ç ä¸ç¥¨æ®å¼¹çª— -->
        <el-dialog v-model="showQR" title="å‡­è¯äºŒç»´ç ä¸ç¥¨æ®" width="700px">
            <div style="text-align: center;">
                <h4>{{ currentVoucher.customer }} - {{ currentVoucher.sku }}</h4>
                <p><strong>å‡­è¯å·ï¼š</strong>{{ currentVoucher.voucher_id }}</p>
                <p><strong>éªŒè¯é“¾æ¥ï¼š</strong>{{ verifyLink }}</p>
                
                <div style="margin: 20px 0;" id="qr-container">
                    <canvas 
                        ref="qrCanvas" 
                        width="200" 
                        height="200" 
                        style="display: none;">
                    </canvas>
                </div>
                
                <div style="margin: 20px 0;">
                    <el-button type="primary" @click="copyLink">ğŸ“‹ å¤åˆ¶é“¾æ¥</el-button>
                    <el-button type="success" @click="downloadQR">â¬‡ï¸ ä¸‹è½½äºŒç»´ç </el-button>
                    <el-button type="warning" @click="generateVoucherImage" :loading="generatingImage">ğŸ–¼ï¸ ç”Ÿæˆç¥¨æ®å›¾ç‰‡</el-button>
                </div>

                <!-- ç¥¨æ®å›¾ç‰‡é¢„è§ˆ -->
                <div v-if="voucherImageUrl" style="margin-top: 20px;">
                    <h4>ç¥¨æ®å›¾ç‰‡é¢„è§ˆ</h4>
                    <img :src="voucherImageUrl" alt="å‡­è¯å›¾ç‰‡" style="max-width: 100%; border: 1px solid #ddd; margin: 10px 0;">
                    <div>
                        <el-button @click="downloadVoucherImage">â¬‡ï¸ ä¸‹è½½ç¥¨æ®å›¾ç‰‡</el-button>
                    </div>
                </div>
            </div>
        </el-dialog>
</div>

<script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue
        
        const app = createApp({
  setup() {
                // æ•°æ®
    const vouchers = ref([])
                const loading = ref(false)
                const saving = ref(false)
    const showAdd = ref(false)
                const showEdit = ref(false)
                const showQR = ref(false)
                const searchText = ref('')
                const title = ref('ä¼˜æƒ å‡­è¯ç®¡ç†ç³»ç»Ÿ')
                const currentPage = ref(1)
                const pageSize = ref(100)
                const currentVoucher = ref({})
                const verifyLink = ref('')
                const qrCanvas = ref(null)
                const fileInput = ref(null)
                const voucherImageUrl = ref('')
                const generatingImage = ref(false)
                
                const newVoucher = ref({
                    customer: '',
                    sku: '',
                    qty: 1,
                    price: 0
                })

                const editingVoucher = ref({})
                
                // å®‰å…¨çš„æ¶ˆæ¯æç¤ºå‡½æ•°
                const safeMessage = {
                    success: (msg) => {
                        try {
                            if (typeof ElMessage !== 'undefined') {
                                ElMessage.success(msg)
                            } else {
                                console.log('âœ… Success:', msg)
                                showToast(msg, 'success')
                            }
                        } catch (e) {
                            console.log('âœ… Success:', msg)
                            showToast(msg, 'success')
                        }
                    },
                    error: (msg) => {
                        try {
                            if (typeof ElMessage !== 'undefined') {
                                ElMessage.error(msg)
                            } else {
                                console.error('âŒ Error:', msg)
                                showToast(msg, 'error')
                            }
                        } catch (e) {
                            console.error('âŒ Error:', msg)
                            showToast(msg, 'error')
                        }
                    },
                    warning: (msg) => {
                        try {
                            if (typeof ElMessage !== 'undefined') {
                                ElMessage.warning(msg)
                            } else {
                                console.warn('âš ï¸ Warning:', msg)
                                showToast(msg, 'warning')
                            }
                        } catch (e) {
                            console.warn('âš ï¸ Warning:', msg)
                            showToast(msg, 'warning')
                        }
                    }
                }

                // ç®€å•çš„toastå®ç°ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
                const showToast = (message, type = 'info') => {
                    const toast = document.createElement('div')
                    const colors = {
                        success: '#67C23A',
                        error: '#F56C6C',
                        warning: '#E6A23C',
                        info: '#909399'
                    }
                    
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: ${colors[type] || colors.info};
                        color: white;
                        padding: 12px 20px;
                        border-radius: 4px;
                        z-index: 9999;
                        font-size: 14px;
                        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                        max-width: 300px;
                        word-break: break-word;
                    `
                    
                    toast.textContent = message
                    document.body.appendChild(toast)
                    
                    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.style.opacity = '0'
                            toast.style.transform = 'translateX(100%)'
                            setTimeout(() => {
                                if (toast.parentNode) {
                                    document.body.removeChild(toast)
                                }
                            }, 300)
                        }
                    }, 3000)
                }
                
                // è®¡ç®—å±æ€§
                const filteredVouchers = computed(() => {
                    if (!searchText.value) return vouchers.value || []
                    const search = searchText.value.toLowerCase()
                    return (vouchers.value || []).filter(v => 
                        (v.customer || '').toLowerCase().includes(search) ||
                        (v.sku || '').toLowerCase().includes(search) ||
                        (v.voucher_id || '').toLowerCase().includes(search)
                    )
                })
                
                const totalPages = computed(() => Math.ceil(filteredVouchers.value.length / pageSize.value))
                
                const paginatedVouchers = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value
                    const end = start + pageSize.value
                    return filteredVouchers.value.slice(start, end)
                })
                
                const totalVouchers = computed(() => (vouchers.value || []).length)
                const unusedVouchers = computed(() => (vouchers.value || []).filter(v => v.status === 'æœªä½¿ç”¨').length)
                const usedVouchers = computed(() => (vouchers.value || []).filter(v => v.status === 'å·²ä½¿ç”¨').length)
                const totalAmount = computed(() => (vouchers.value || []).reduce((sum, v) => sum + Number(v.price || 0), 0).toFixed(2))
                const usedAmount = computed(() => (vouchers.value || []).filter(v => v.status === 'å·²ä½¿ç”¨').reduce((sum, v) => sum + Number(v.price || 0), 0).toFixed(2))
                const unusedAmount = computed(() => (vouchers.value || []).filter(v => v.status === 'æœªä½¿ç”¨').reduce((sum, v) => sum + Number(v.price || 0), 0).toFixed(2))
                
                // æ–¹æ³•
                const loadData = async () => {
                    loading.value = true
                    try {
                        const response = await fetch('/api/list')
                        if (response.ok) {
                            const data = await response.json()
                            vouchers.value = Array.isArray(data) ? data : []
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('åŠ è½½æ•°æ®å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                            vouchers.value = []
                        }
                    } catch (error) {
                        safeMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                        vouchers.value = []
                        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error)
                    } finally {
                        loading.value = false
                    }
                }
                
                const refreshData = async () => {
                    try {
                        await loadData()
                        safeMessage.success('æ•°æ®åˆ·æ–°æˆåŠŸ')
                    } catch (error) {
                        safeMessage.error('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message)
                    }
                }
                
                const addVoucher = async () => {
                    if (!newVoucher.value.customer || !newVoucher.value.sku) {
                        safeMessage.error('è¯·å¡«å†™å®¢æˆ·å’Œæ¬¾å·')
                        return
                    }
                    
                    saving.value = true
                    try {
                        const response = await fetch('/api/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...newVoucher.value,
                                voucher_id: `V${Date.now()}`
                            })
                        })
                        
                        if (response.ok) {
                            showAdd.value = false
                            newVoucher.value = { customer: '', sku: '', qty: 1, price: 0 }
                            await loadData()
                            safeMessage.success('å‡­è¯æ·»åŠ æˆåŠŸ')
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('æ·»åŠ å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('æ·»åŠ é”™è¯¯:', error)
                        safeMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                    } finally {
                        saving.value = false
                    }
                }
                
                const editVoucher = (voucher) => {
                    editingVoucher.value = { ...voucher }
                    showEdit.value = true
                }

                const updateVoucher = async () => {
                    if (!editingVoucher.value.customer || !editingVoucher.value.sku) {
                        safeMessage.error('è¯·å¡«å†™å®¢æˆ·å’Œæ¬¾å·')
                        return
                    }
                    
                    saving.value = true
                    try {
                        const response = await fetch(`/api/update/${editingVoucher.value.voucher_id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(editingVoucher.value)
                        })
                        
                        if (response.ok) {
                            showEdit.value = false
                            await loadData()
                            safeMessage.success('å‡­è¯æ›´æ–°æˆåŠŸ')
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('æ›´æ–°å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('æ›´æ–°é”™è¯¯:', error)
                        safeMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                    } finally {
                        saving.value = false
                    }
                }
                
                const confirmDelete = async (voucherId) => {
                    try {
                        // å°è¯•ä½¿ç”¨ElMessageBoxï¼Œå¦‚æœå¤±è´¥åˆ™é™çº§åˆ°åŸç”Ÿconfirm
                        let confirmed = false
                        try {
                            if (typeof ElMessageBox !== 'undefined') {
                                await ElMessageBox.confirm(
                                    'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‡­è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼',
                                    'ç¡®è®¤åˆ é™¤',
                                    {
                                        confirmButtonText: 'ç¡®å®š',
                                        cancelButtonText: 'å–æ¶ˆ',
                                        type: 'warning',
                                    }
                                )
                                confirmed = true
                            } else {
                                // é™çº§å¤„ç†
                                confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‡­è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')
                            }
                        } catch (confirmError) {
                            if (confirmError === 'cancel') {
                                return  // ç”¨æˆ·å–æ¶ˆ
                            }
                            // ElMessageBoxå¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿconfirmä½œä¸ºé™çº§
                            confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‡­è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')
                        }
                        
                        if (confirmed) {
                            await deleteVoucher(voucherId)
                        }
                    } catch (error) {
                        console.error('åˆ é™¤ç¡®è®¤é”™è¯¯:', error)
                        safeMessage.error('åˆ é™¤æ“ä½œå¤±è´¥: ' + error.message)
                    }
                }

                const deleteVoucher = async (voucherId) => {
                    try {
                        const response = await fetch(`/api/delete/${voucherId}`, { method: 'POST' })
                        if (response.ok) {
                            await loadData()
                            safeMessage.success('åˆ é™¤æˆåŠŸ')
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('åˆ é™¤å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('åˆ é™¤é”™è¯¯:', error)
                        safeMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                    }
                }
                
                const toggleStatus = async (voucher) => {
                    if (voucher.status === 'å·²ä½¿ç”¨') {
                        safeMessage.warning('è¯¥å‡­è¯å·²ç»ä½¿ç”¨è¿‡äº†')
                        return
                    }
                    
                    try {
                        // å°è¯•ä½¿ç”¨ElMessageBoxï¼Œå¦‚æœå¤±è´¥åˆ™é™çº§åˆ°åŸç”Ÿconfirm
                        let confirmed = false
                        try {
                            if (typeof ElMessageBox !== 'undefined') {
                                await ElMessageBox.confirm(
                                    `ç¡®å®šè¦æ ¸é”€å‡­è¯ ${voucher.voucher_id} å—ï¼Ÿ`,
                                    'ç¡®è®¤æ ¸é”€',
                                    {
                                        confirmButtonText: 'ç¡®å®š',
                                        cancelButtonText: 'å–æ¶ˆ',
                                        type: 'warning',
                                    }
                                )
                                confirmed = true
                            } else {
                                // é™çº§å¤„ç†
                                confirmed = confirm(`ç¡®å®šè¦æ ¸é”€å‡­è¯ ${voucher.voucher_id} å—ï¼Ÿ`)
                            }
                        } catch (confirmError) {
                            if (confirmError === 'cancel') {
                                return  // ç”¨æˆ·å–æ¶ˆ
                            }
                            // ElMessageBoxå¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿconfirmä½œä¸ºé™çº§
                            confirmed = confirm(`ç¡®å®šè¦æ ¸é”€å‡­è¯ ${voucher.voucher_id} å—ï¼Ÿ`)
                        }
                        
                        if (!confirmed) {
                            return  // ç”¨æˆ·å–æ¶ˆ
                        }
                        
                        const response = await fetch(`/api/use_voucher/${voucher.voucher_id}`, { 
                            method: 'POST' 
                        })
                        
                        if (response.ok) {
                            await loadData()
                            safeMessage.success('å‡­è¯æ ¸é”€æˆåŠŸ')
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('æ ¸é”€å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('æ ¸é”€é”™è¯¯:', error)
                        safeMessage.error('æ ¸é”€å¤±è´¥: ' + error.message)
                    }
                }
                
                const showQRCode = (voucher) => {
                    currentVoucher.value = voucher
                    verifyLink.value = `${window.location.origin}/verify/${voucher.voucher_id}`
                    voucherImageUrl.value = ''
                    showQR.value = true
                    
                    console.log('æ˜¾ç¤ºäºŒç»´ç å¼¹çª—:', {
                        voucher_id: voucher.voucher_id,
                        verifyLink: verifyLink.value
                    })
                    
                    // ç­‰å¾…DOMæ›´æ–°åç”ŸæˆäºŒç»´ç ï¼Œå¤šçº§å»¶è¿Ÿç¡®ä¿å…ƒç´ å‡†å¤‡å¥½
                    nextTick(() => {
                        setTimeout(() => {
                            console.log('å‡†å¤‡ç”ŸæˆäºŒç»´ç ï¼Œcanvaså­˜åœ¨:', !!qrCanvas.value)
                            generateQR()
                        }, 100)  // å¢åŠ å»¶è¿Ÿç¡®ä¿ç”»å¸ƒå…ƒç´ å®Œå…¨æ¸²æŸ“
                    })
                }
                
                const generateQR = () => {
                    console.log('ç”ŸæˆäºŒç»´ç å¼€å§‹...', {
                        canvas: !!qrCanvas.value,
                        QRCode: typeof QRCode !== 'undefined',
                        link: verifyLink.value
                    })
                    
                    if (!verifyLink.value) {
                        console.error('éªŒè¯é“¾æ¥ä¸ºç©º')
                        safeMessage.error('éªŒè¯é“¾æ¥ä¸ºç©º')
                        return
                    }
                    
                    if (typeof QRCode === 'undefined') {
                        console.error('QRCodeåº“æœªåŠ è½½')
                        safeMessage.error('äºŒç»´ç åº“æœªåŠ è½½')
                        return
                    }
                    
                    try {
                        console.log('å¼€å§‹ç”ŸæˆçœŸæ­£çš„äºŒç»´ç :', verifyLink.value)
                        
                        // è·å–äºŒç»´ç å®¹å™¨
                        const container = document.getElementById('qr-container') || qrCanvas.value?.parentNode
                        
                        if (!container) {
                            console.error('äºŒç»´ç å®¹å™¨æœªæ‰¾åˆ°')
                            safeMessage.error('äºŒç»´ç å®¹å™¨æœªæ‰¾åˆ°')
                            return
                        }
                        
                        // æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç 
                        const existingQR = container.querySelector('.qr-code-wrapper')
                        if (existingQR) {
                            existingQR.remove()
                        }
                        
                        // åˆ›å»ºå±…ä¸­çš„äºŒç»´ç åŒ…è£…å™¨
                        const qrWrapper = document.createElement('div')
                        qrWrapper.className = 'qr-code-wrapper'
                        qrWrapper.style.cssText = `
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 100%;
                            margin: 10px 0;
                        `
                        
                        // åˆ›å»ºäºŒç»´ç å®¹å™¨
                        const qrDiv = document.createElement('div')
                        qrDiv.style.cssText = `
                            width: 200px;
                            height: 200px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            background-color: white;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            padding: 10px;
                        `
                        
                        qrWrapper.appendChild(qrDiv)
                        container.appendChild(qrWrapper)
                        
                        // ç”ŸæˆçœŸæ­£çš„äºŒç»´ç 
                        const qr = new QRCode(qrDiv, {
                            text: verifyLink.value,
                            width: 180,
                            height: 180,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.M
                        })
                        
                        console.log('çœŸæ­£çš„äºŒç»´ç ç”ŸæˆæˆåŠŸ')
                        safeMessage.success('äºŒç»´ç ç”ŸæˆæˆåŠŸï¼ˆå¯æ‰«æï¼‰')
                        
                    } catch (error) {
                        console.error('äºŒç»´ç ç”Ÿæˆå¼‚å¸¸:', error)
                        safeMessage.error('äºŒç»´ç ç”Ÿæˆå¼‚å¸¸: ' + error.message)
                    }
                }
                
                const copyLink = () => {
                    // å…¼å®¹æ€§æ›´å¥½çš„å¤åˆ¶æ–¹æ³•
                    if (navigator.clipboard && window.isSecureContext) {
                        // ç°ä»£æµè§ˆå™¨çš„clipboard API
                        navigator.clipboard.writeText(verifyLink.value).then(() => {
                            safeMessage.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
                        }).catch(() => {
                            fallbackCopyTextToClipboard(verifyLink.value)
                        })
                    } else {
                        // å…¼å®¹æ—§æµè§ˆå™¨æˆ–éHTTPSç¯å¢ƒ
                        fallbackCopyTextToClipboard(verifyLink.value)
                    }
                }
                
                // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
                const fallbackCopyTextToClipboard = (text) => {
                    try {
                        const textArea = document.createElement("textarea")
                        textArea.value = text
                        textArea.style.position = "fixed"
                        textArea.style.left = "-999999px"
                        textArea.style.top = "-999999px"
                        document.body.appendChild(textArea)
                        textArea.focus()
                        textArea.select()
                        
                        const successful = document.execCommand('copy')
                        document.body.removeChild(textArea)
                        
                        if (successful) {
                            safeMessage.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
                        } else {
                            safeMessage.warning('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥')
                        }
                    } catch (err) {
                        console.error('å¤åˆ¶å¤±è´¥:', err)
                        safeMessage.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é“¾æ¥')
                    }
                }
                
                const downloadQR = () => {
                    try {
                        // æŸ¥æ‰¾ç”Ÿæˆçš„äºŒç»´ç å›¾åƒ
                        const qrContainer = document.getElementById('qr-container')
                        const qrWrapper = qrContainer?.querySelector('.qr-code-wrapper')
                        if (!qrWrapper) {
                            safeMessage.error('è¯·å…ˆç”ŸæˆäºŒç»´ç ')
                            return
                        }
                        
                        const qrImg = qrWrapper.querySelector('img')
                        const qrCanvas = qrWrapper.querySelector('canvas')
                        
                        if (qrImg) {
                            // å¦‚æœæ˜¯imgå…ƒç´ ï¼Œç›´æ¥ä¸‹è½½
                            const link = document.createElement('a')
                            link.download = `qr_${currentVoucher.value.voucher_id}.png`
                            link.href = qrImg.src
                            link.click()
                            safeMessage.success('äºŒç»´ç ä¸‹è½½æˆåŠŸ')
                        } else if (qrCanvas) {
                            // å¦‚æœæ˜¯canvaså…ƒç´ ï¼Œè½¬æ¢ä¸ºæ•°æ®URL
                            const link = document.createElement('a')
                            link.download = `qr_${currentVoucher.value.voucher_id}.png`
                            link.href = qrCanvas.toDataURL()
                            link.click()
                            safeMessage.success('äºŒç»´ç ä¸‹è½½æˆåŠŸ')
                        } else {
                            safeMessage.error('æœªæ‰¾åˆ°å¯ä¸‹è½½çš„äºŒç»´ç ')
                        }
                    } catch (error) {
                        console.error('ä¸‹è½½äºŒç»´ç å¤±è´¥:', error)
                        safeMessage.error('ä¸‹è½½å¤±è´¥: ' + error.message)
                    }
                }

                const generateVoucherImage = async () => {
                    generatingImage.value = true
                    try {
                        const response = await fetch(`/api/generate_voucher/${currentVoucher.value.voucher_id}`, {
                            method: 'POST'
                        })
                        const data = await response.json()
                        if (response.ok) {
                            voucherImageUrl.value = data.voucher_image
                            safeMessage.success('ç¥¨æ®å›¾ç‰‡ç”ŸæˆæˆåŠŸ')
                        } else {
                            safeMessage.error('ç”Ÿæˆç¥¨æ®å›¾ç‰‡å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'))
                        }
                    } catch (error) {
                        safeMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                        console.error('ç”Ÿæˆç¥¨æ®å›¾ç‰‡é”™è¯¯:', error)
                    } finally {
                        generatingImage.value = false
                    }
                }

                const downloadVoucherImage = () => {
                    if (voucherImageUrl.value) {
                        const link = document.createElement('a')
                        link.href = voucherImageUrl.value
                        link.download = `voucher_${currentVoucher.value.voucher_id}.png`
                        document.body.appendChild(link)
                        link.click()
                        document.body.removeChild(link)
                        safeMessage.success('ç¥¨æ®å›¾ç‰‡ä¸‹è½½å¼€å§‹')
                    } else {
                        safeMessage.warning('è¯·å…ˆç”Ÿæˆç¥¨æ®å›¾ç‰‡')
                    }
                }

                // å¯¼å‡ºExcel
                const exportExcel = async () => {
                    try {
                        if (vouchers.value.length === 0) {
                            safeMessage.warning('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º')
                            return
                        }

                        safeMessage.success('æ­£åœ¨å¯¼å‡ºExcelæ–‡ä»¶...')
                        
                        const response = await fetch('/api/export', {
                            method: 'GET'
                        })
                        
                        if (response.ok) {
                            // è·å–æ–‡ä»¶å
                            const contentDisposition = response.headers.get('Content-Disposition')
                            let filename = 'vouchers_export.xlsx'
                            if (contentDisposition) {
                                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/)
                                if (match) {
                                    filename = match[1].replace(/['"]/g, '')
                                }
                            }
                            
                            // ä¸‹è½½æ–‡ä»¶
                            const blob = await response.blob()
                            const url = window.URL.createObjectURL(blob)
                            const link = document.createElement('a')
                            link.href = url
                            link.download = filename
                            document.body.appendChild(link)
                            link.click()
                            document.body.removeChild(link)
                            window.URL.revokeObjectURL(url)
                            
                            safeMessage.success('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ')
                        } else {
                            const errorData = await response.json().catch(() => ({}))
                            safeMessage.error('å¯¼å‡ºå¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('å¯¼å‡ºé”™è¯¯:', error)
                        safeMessage.error('å¯¼å‡ºå¤±è´¥: ' + error.message)
                    }
                }

                // å¯¼å…¥Excel
                const importExcel = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return
                    
                    try {
                        if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                            safeMessage.error('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰')
                            return
                        }
                        
                        const formData = new FormData()
                        formData.append('file', file)
                        
                        safeMessage.success('æ­£åœ¨å¯¼å…¥Excelæ–‡ä»¶...')
                        
                        const response = await fetch('/api/import', {
                            method: 'POST',
                            body: formData
                        })
                        
                        const data = await response.json()
                        
                        if (response.ok) {
                            await loadData()  // åˆ·æ–°æ•°æ®
                            
                            let message = `å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.imported_count} æ¡è®°å½•ï¼Œå½“å‰æ€»æ•° ${data.total_count} æ¡`
                            
                            if (data.warnings) {
                                safeMessage.warning(message + '\n' + data.warnings)
                            } else {
                                safeMessage.success(message)
                            }
                            
                            // å¦‚æœæœ‰é”™è¯¯è¯¦æƒ…ï¼Œåœ¨æ§åˆ¶å°è¾“å‡º
                            if (data.error_details && data.error_details.length > 0) {
                                console.warn('å¯¼å…¥æ—¶è·³è¿‡çš„è¡Œ:', data.error_details)
                            }
                        } else {
                            safeMessage.error('å¯¼å…¥å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'))
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥é”™è¯¯:', error)
                        safeMessage.error('å¯¼å…¥å¤±è´¥: ' + error.message)
                    } finally {
                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                        event.target.value = ''
                    }
                }
                
                const handleSizeChange = (newSize) => {
                    pageSize.value = newSize
                    currentPage.value = 1
                }
                
                const handleCurrentChange = (newPage) => {
                    currentPage.value = newPage
                }
                
                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    setTimeout(() => {
                        loadData()
                    }, 100)
                })
                
                return {
                    vouchers,
                    loading,
                    saving,
                    showAdd,
                    showEdit,
                    showQR,
                    searchText,
                    title,
                    currentPage,
                    pageSize,
                    totalPages,
                    newVoucher,
                    editingVoucher,
                    currentVoucher,
                    verifyLink,
                    qrCanvas,
                    fileInput,
                    voucherImageUrl,
                    generatingImage,
                    filteredVouchers,
                    paginatedVouchers,
                    totalVouchers,
                    unusedVouchers,
                    usedVouchers,
                    totalAmount,
                    usedAmount,
                    unusedAmount,
                    loadData,
                    refreshData,
                    addVoucher,
                    editVoucher,
                    updateVoucher,
                    confirmDelete,
                    deleteVoucher,
                    toggleStatus,
                    showQRCode,
                    copyLink,
                    downloadQR,
                    generateVoucherImage,
                    downloadVoucherImage,
                    exportExcel,
                    importExcel,
                    handleSizeChange,
                    handleCurrentChange
                }
            }
        })
        
        // ç›´æ¥æŒ‚è½½Vueåº”ç”¨
        app.use(ElementPlus).mount('#app')
        console.log('Vueåº”ç”¨å·²æŒ‚è½½')
</script>
</body>
</html>